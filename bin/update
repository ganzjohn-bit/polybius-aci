#!/usr/bin/env bash
set -e

cd "$(dirname "$0")/.."

echo "Updating Polybius..."
echo ""

# Fetch latest
if ! git fetch origin main 2>/dev/null; then
  echo "Couldn't connect to GitHub. Check your internet connection."
  exit 1
fi

# Check if already up-to-date
if [ "$(git rev-parse HEAD)" = "$(git rev-parse origin/main)" ]; then
  echo "Already up-to-date!"
  exit 0
fi

# Check for local changes
if ! git diff --quiet || ! git diff --cached --quiet || [[ -n $(git ls-files --others --exclude-standard) ]]; then
  echo "You have local changes. Run 'bin/save' first, or discard them with 'git checkout . && git clean -fd'"
  exit 1
fi

# Update
git checkout main 2>/dev/null
git pull origin main
npm install --silent

echo ""
echo "Updated!"
echo ""
